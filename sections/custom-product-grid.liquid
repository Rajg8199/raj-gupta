{% comment %}
  Custom Product Grid with Modal
  Theme: Horizon
  Author: Senior Shopify Implementation
{% endcomment %}

<section class="custom-product-grid">
  <div class="custom-container">
    <h2 class="grid-title">{{ section.settings.heading }}</h2>

    <div class="grid-wrapper">
      {% for block in section.blocks %}
        {% assign product = block.settings.product %}
        {% if product %}
          <div
            class="grid-item"
            data-product='{{ product | json | escape }}'
          >
            <img
              src="{{ product.featured_image | image_url: width: 700 }}"
              alt="{{ product.title }}"
              loading="lazy"
            >
            <button class="open-modal-btn" aria-label="Open product">+</button>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- MODAL -->
  <div class="product-modal" hidden>
    <div class="modal-overlay"></div>

    <div class="modal-content">
      <button class="modal-close">×</button>

      <div class="modal-header">
        <img class="modal-image" src="" alt="">
        <div class="modal-info">
          <h3 class="modal-title"></h3>
          <p class="modal-price"></p>
          <p class="modal-description"></p>
        </div>
      </div>

      <div class="modal-options"></div>

      <button class="add-to-cart-btn">
        ADD TO CART →
      </button>
    </div>
  </div>
</section>

<style>
/* ------------------------------
   Layout
-------------------------------- */
.custom-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 24px;
}

.grid-title {
  margin-bottom: 32px;
}

.grid-wrapper {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 24px;
}

.grid-item {
  position: relative;
  cursor: pointer;
}

.grid-item img {
  width: 100%;
  display: block;
}

.open-modal-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #fff;
  border: 1px solid #000;
}

/* ------------------------------
   Modal
-------------------------------- */
.product-modal {
  position: fixed;
  inset: 0;
  z-index: 9999;
}

.modal-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.5);
}

.modal-content {
  background: var(--color-background, #fff);
  color: var(--color-text, #000);
  max-width: 420px;
  width: 100%;
  margin: auto;
  padding: 24px;
  position: relative;
}

.modal-close {
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 20px;
}

.modal-header {
  display: flex;
  gap: 16px;
}

.modal-image {
  width: 120px;
}

.modal-options {
  margin-top: 24px;
}

.option-group {
  margin-bottom: 16px;
}

.option-group button {
  margin-right: 8px;
  margin-top: 8px;
  padding: 6px 12px;
  border: 1px solid #000;
  background: #fff;
}

.option-group button.active {
  background: #000;
  color: #fff;
}

.add-to-cart-btn {
  margin-top: 24px;
  width: 100%;
  padding: 14px;
  background: #000;
  color: #fff;
}

/* ------------------------------
   Mobile
-------------------------------- */
@media (max-width: 768px) {
  .grid-wrapper {
    grid-template-columns: repeat(2, 1fr);
  }

  .modal-content {
    max-width: 100%;
    height: 100%;
    border-radius: 0;
  }
}
</style>

<script>
/* ======================================
   Product Grid Modal – Vanilla JS
====================================== */

document.addEventListener('DOMContentLoaded', () => {
  const modal = document.querySelector('.product-modal');
  const overlay = modal.querySelector('.modal-overlay');
  const closeBtn = modal.querySelector('.modal-close');
  const addToCartBtn = modal.querySelector('.add-to-cart-btn');

  let currentProduct = null;
  let selectedOptions = {};

  document.querySelectorAll('.grid-item').forEach(card => {
    card.addEventListener('click', () => {
      currentProduct = JSON.parse(card.dataset.product);
      openModal(currentProduct);
    });
  });

  function openModal(product) {
    modal.hidden = false;
    selectedOptions = {};

    modal.querySelector('.modal-image').src =
      product.featured_image || product.images[0];

    modal.querySelector('.modal-title').textContent = product.title;
    modal.querySelector('.modal-price').textContent =
      (product.price / 100).toFixed(2) + '€';

    modal.querySelector('.modal-description').textContent =
      product.description.replace(/(<([^>]+)>)/gi, '');

    renderOptions(product);
  }

  function renderOptions(product) {
    const container = modal.querySelector('.modal-options');
    container.innerHTML = '';

    product.options.forEach((option, index) => {
      const group = document.createElement('div');
      group.className = 'option-group';
      group.innerHTML = `<p>${option.name}</p>`;

      option.values.forEach(value => {
        const btn = document.createElement('button');
        btn.textContent = value;

        btn.addEventListener('click', () => {
          selectedOptions[option.name] = value;
          group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });

        group.appendChild(btn);
      });

      container.appendChild(group);
    });
  }

  addToCartBtn.addEventListener('click', () => {
    const variant = currentProduct.variants.find(v =>
      Object.keys(selectedOptions).every(
        key => v.options.includes(selectedOptions[key])
      )
    );

    if (!variant) {
      alert('Please select all options');
      return;
    }

    addItemToCart(variant.id).then(() => {
      if (
        selectedOptions.Color === 'Black' &&
        selectedOptions.Size === 'Medium'
      ) {
        addSoftWinterJacket();
      }
    });
  });

  function addItemToCart(id) {
    return fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, quantity: 1 })
    });
  }

  function addSoftWinterJacket() {
    fetch('/products/soft-winter-jacket.js')
      .then(res => res.json())
      .then(product => {
        const variant = product.variants.find(v => v.available);
        if (variant) addItemToCart(variant.id);
      });
  }

  closeBtn.addEventListener('click', closeModal);
  overlay.addEventListener('click', closeModal);

  function closeModal() {
    modal.hidden = true;
  }
});
</script>

{% schema %}
{
  "name": "Custom Product Grid",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section heading",
      "default": "Tisso vision in the wild"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select product"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Custom Product Grid"
    }
  ]
}
{% endschema %}
