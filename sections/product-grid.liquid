

<style>
  .product-grid-section {
    position: relative;
    width: 100%;
    margin: 0px auto;
    max-width: 1440px;
    display: flex;
    padding: 90px 52px 0px 52px;
    gap: 30px;
    flex-direction: column;
  }

  h2.product-grid__heading {
    font-size: 36px;
    font-family:'Lustria-Regular';
    line-height: 120%;
  }

  .product-grid-section * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  .product-grid__container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0;
    max-width: 100%;
  }

  .product-card {
    position: relative;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    cursor: pointer;
    background-color: #f5f5f5;
  }

  .product-card__image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .product-card:hover .product-card__image {
    transform: scale(1.05);
  }

  .product-card__quick-view {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 22px;
    height: 22px;
    background-color: rgba(255, 255, 255, 0.95);
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s ease;
    cursor: pointer;
    z-index: 2;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .product-card:hover .product-card__quick-view {
    opacity: 1;
  }

  .product-card__quick-view:hover {
    background-color: #ffffff;
    transform: translate(-50%, -50%) scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }

  .product-card__quick-view svg {
    width: 12px;
    height: 12px;
  }

  .quick-view-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .quick-view-modal.active {
    display: flex;
    opacity: 1;
  }

  .quick-view-modal__content {
    background-color: #ffffff;
    width: 90%;
    max-width: 380px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 40px 20px;
    position: relative;
    border-radius: 0;
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .quick-view-modal.active .quick-view-modal__content {
    transform: scale(1);
  }

  .quick-view-modal__close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    background-color: transparent;
    border: none;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
  }

  .quick-view-modal__close:hover {
    transform: rotate(90deg);
  }

  .quick-view-modal__close svg {
    width: 20px;
    height: 20px;
  }

  .quick-view-modal__image-wrapper {
    width: 100%;
    display: flex;
    align-items: flex-end;
  }

  .quick-view-modal__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .quick-view-modal__title {
    font-family: 'Jost-light';
    font-size: 16px;
    font-weight: 600;
    color: black;
    margin: 0;
    line-height: 1.3;
  }

  .quick-view-modal__price {
    font-family: 'Lustria-Regular';
    font-size: 16px;
    font-weight: 600;
    color: black;
    margin: 0;
  }

  .quick-view-modal__description {
    font-family: 'Jost-light';
    font-size: 14px;
    font-weight: 400;
    color: black;
    line-height: 110%;
    margin: 0;
  }

  .quick-view-modal__option {
    margin-bottom: 20px;
  }

  .quick-view-modal__option-label {
    font-family: 'Jost-Regular';
    font-size: 14px;
    color: black;
    line-height: 130%;
    margin: 10px 0px;
    display: block;
  }

  .quick-view-modal__color-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }

  .quick-view-modal__color-option {
    position: relative;
    padding: 12px 16px 12px 24px;
    border: 0.5px solid black;
    background-color: #ffffff;
    font-family: 'Jost-Regular';
    font-size: 14px;
    font-weight: 500;
    color: black;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    overflow: hidden;
  }

  .quick-view-modal__color-option::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 5px;
    background-color: var(--color-value, #e0e0e0);
    transition: background-color 0.2s ease;
  }

  .quick-view-modal__color-option:hover {
    border-color: black;
  }

  .quick-view-modal__color-option.selected {
    border-color: black;
    background-color: black;
    color: #ffffff;
  }

  .quick-view-modal__color-option.selected::before {
    background-color: black;
  }

  .quick-view-modal__size-select {
    width: 100%;
    padding: 12px 16px;
    border: 0.5px solid black;
    background-color: #ffffff;
    font-family: 'Jost-Regular';
    font-size: 16px;
    font-weight: 500;
    border-radius:0;
    letter-spacing: -0.2px;
    color: black;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='15' height='9' viewBox='0 0 15 9' fill='none'%3E%3Cpath d='M1.06067 1.06067L7.06067 7.06067L13.0607 1.06067' stroke='%23000000' stroke-width='1.5' stroke-linecap='square'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }

  .quick-view-modal__size-select:focus {
    outline: none;
    border-color: black;
  }

  .quick-view-modal__add-to-cart {
    width: 100%;
    padding: 16px;
    background-color: black;
    color: #ffffff;
    border: none;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 24px;
  }

  .quick-view-modal__add-to-cart:hover:not(:disabled) {
    background-color: #2d2d2d;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .quick-view-modal__add-to-cart:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  .quick-view-modal__add-to-cart svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
  }

  .quick-view-modal__add-to-cart.loading {
    pointer-events: none;
  }

  .quick-view-modal__add-to-cart.loading::after {
    content: '';
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  
  .quick-view-modal__top {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 16px;
  }

  .quick-view-modal__image-col img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }

  .quick-view-modal__info-col {
    display: flex;
    flex-direction: column;
    gap: 8px;
    justify-content: flex-end;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @media screen and (max-width: 989px) {
    .product-grid-section {
      padding: 60px 32px 0px 32px;
    }
    h2.product-grid__heading {
      font-size: 30px;
    }
    .product-grid__container {
      grid-template-columns: repeat(2, 1fr);
    }
    .quick-view-modal__content {
      max-width: 95%;
    }
  }

  @media screen and (max-width: 749px) {
    .product-grid-section {
      padding: 40px 16px 0px 16px;
      gap: 24px;
    }
    h2.product-grid__heading {
      font-size: 24px;
    }
    .quick-view-modal__top {
      grid-template-columns: 1fr;
    }
    .quick-view-modal__image-col img {
      height: 220px;
    }
  }

  .hidden {
    display: none !important;
  }

  body.modal-open {
    overflow: hidden;
  }
</style>

<section class="product-grid-section" id="product-grid-{{ section.id }}">
  {%- if section.settings.vision_text != blank -%}
    <h2 class="product-grid__heading">{{ section.settings.vision_text }}</h2>
  {%- endif -%}

  <div class="product-grid__container">
    {%- for block in section.blocks -%}
      {%- if block.type == 'product' and block.settings.product != blank -%}
        {%- assign product = block.settings.product -%}
        <div class="product-card" data-product-id="{{ product.id }}">
          <div class="product-card__image-wrapper">
            {%- if product.featured_image -%}
              <img class="product-card__image" src="{{ product.featured_image | image_url: width: 800 }}" alt="{{ product.featured_image.alt | escape }}" loading="lazy">
            {%- endif -%}
            <button class="product-card__quick-view" type="button" aria-label="Quick view {{ product.title }}" data-quick-view-trigger="{{ product.id }}">
              <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                <path d="M4.98047 0.75V9.21154" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                <path d="M0.75 4.98071H9.21154" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>
</section>

<div class="quick-view-modal" id="quick-view-modal-{{ section.id }}">
  <div class="quick-view-modal__content">
    <button class="quick-view-modal__close" type="button" aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>

    <div class="quick-view-modal__top">
      <div class="quick-view-modal__image-col">
        <img class="quick-view-modal__image" id="modal-image-{{ section.id }}" />
      </div>
      <div class="quick-view-modal__info-col">
        <h2 class="quick-view-modal__title" id="modal-title-{{ section.id }}"></h2>
        <p class="quick-view-modal__price" id="modal-price-{{ section.id }}"></p>
        <p class="quick-view-modal__description" id="modal-description-{{ section.id }}"></p>
      </div>
    </div>

    <div class="quick-view-modal__details">
      <form id="quick-view-form-{{ section.id }}">
        <div class="quick-view-modal__option" id="color-option-{{ section.id }}"></div>
        <div class="quick-view-modal__option" id="size-option-{{ section.id }}"></div>
        <input type="hidden" name="id" id="variant-id-{{ section.id }}">
        <button type="submit" class="quick-view-modal__add-to-cart" id="add-to-cart-btn-{{ section.id }}">
          <span>Add to Cart</span>
          <svg width="36" height="12" viewBox="0 0 36 12" fill="none">
            <path d="M0.75 4.77295L9.20657e-08 4.77295L-9.20657e-08 6.27295L0.75 6.27295L0.75 4.77295ZM34.9798 6.05328C35.2727 5.76039 35.2727 5.28551 34.9798 4.99262L30.2068 0.21965C29.9139 -0.0732432 29.4391 -0.0732433 29.1462 0.21965C28.8533 0.512544 28.8533 0.987417 29.1462 1.28031L33.3888 5.52295L29.1462 9.76559C28.8533 10.0585 28.8533 10.5334 29.1462 10.8263C29.4391 11.1191 29.9139 11.1191 30.2068 10.8263L34.9798 6.05328ZM0.75 6.27295L34.4495 6.27295L34.4495 4.77295L0.75 4.77295L0.75 6.27295Z" fill="white"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
(function () {
  const sectionId = '{{ section.id }}';
  const modal = document.getElementById(`quick-view-modal-${sectionId}`);
  const closeBtn = modal.querySelector('.quick-view-modal__close');
  const form = document.getElementById(`quick-view-form-${sectionId}`);
  const cache = {};

  const colorMap = {
    black:'#000', white:'#fff', grey:'#808080', gray:'#808080',
    red:'#f00', blue:'#00f', green:'#008000', yellow:'#ff0',
    orange:'#ffa500', purple:'#800080', pink:'#ffc0cb',
    brown:'#a52a2a', beige:'#f5f5dc', navy:'#000080',
    maroon:'#800000', olive:'#808000', teal:'#008080',
    silver:'#c0c0c0', gold:'#ffd700', cream:'#fffdd0'
  };

  const products = {
    {%- for block in section.blocks -%}
    {%- if block.type == 'product' and block.settings.product != blank -%}
    {%- assign product = block.settings.product -%}
    '{{ product.id }}': {
      id: {{ product.id }},
      title: {{ product.title | json }},
      priceFormatted: {{ product.price | money | json }},
      description: {{ product.description | strip_html | truncate: 150 | json }},
      image: {{ product.featured_image | image_url: width: 800 | json }},
      variants: [
        {%- for v in product.variants -%}
        {
          id: {{ v.id }},
          available: {{ v.available | json }},
          priceFormatted: {{ v.price | money | json }},
          option1: {{ v.option1 | json }},
          option2: {{ v.option2 | json }},
          option3: {{ v.option3 | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ],
      options: [
        {%- for o in product.options_with_values -%}
        { name: {{ o.name | json }}, position: {{ o.position }}, values: {{ o.values | json }} }
        {%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ],
      bundleCheck: {{ block.settings.bundle_variant_check | json }},
      bundleHandle: {{ block.settings.bundle_product_handle | json }}
    }{%- unless forloop.last -%},{%- endunless -%}
    {%- endif -%}
    {%- endfor -%}
  };

  let current = null;
  let selected = {};

  document.querySelectorAll('[data-quick-view-trigger]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      openModal(btn.dataset.quickViewTrigger);
    });
  });

  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', e => e.target === modal && closeModal());
  document.addEventListener('keydown', e => e.key === 'Escape' && closeModal());

  function openModal(id) {
    current = products[id];
    if (!current) return;

    document.getElementById(`modal-title-${sectionId}`).textContent = current.title;
    document.getElementById(`modal-price-${sectionId}`).textContent = current.priceFormatted;
    document.getElementById(`modal-description-${sectionId}`).textContent = current.description;
    document.getElementById(`modal-image-${sectionId}`).src = current.image;

    selected = {};
    renderOptions();

    modal.classList.add('active');
    document.body.classList.add('modal-open');
  }

  function closeModal() {
    modal.classList.remove('active');
    document.body.classList.remove('modal-open');
    current = null;
    selected = {};
  }

  function renderOptions() {
    const colorEl = document.getElementById(`color-option-${sectionId}`);
    const sizeEl = document.getElementById(`size-option-${sectionId}`);
    colorEl.innerHTML = '';
    sizeEl.innerHTML = '';

    current.options.forEach(opt => {
      const name = opt.name.toLowerCase();

      if (name === 'color' || name === 'colour') {
        colorEl.innerHTML = `<label class="quick-view-modal__option-label">Color</label><div class="quick-view-modal__color-grid"></div>`;
        const grid = colorEl.querySelector('.quick-view-modal__color-grid');

        opt.values.forEach(val => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'quick-view-modal__color-option';
          btn.textContent = val;
          btn.style.setProperty('--color-value', colorMap[val.toLowerCase()] || '#e0e0e0');
          btn.onclick = () => {
            grid.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selected[`option${opt.position}`] = val;
            updateVariant();
          };
          grid.appendChild(btn);
        });
      }

      if (name === 'size') {
        sizeEl.innerHTML = `
          <label class="quick-view-modal__option-label">Size</label>
          <select class="quick-view-modal__size-select">
            <option value="">Choose size</option>
            ${opt.values.map(v => `<option value="${v}">${v}</option>`).join('')}
          </select>`;
        sizeEl.querySelector('select').onchange = e => {
          selected[`option${opt.position}`] = e.target.value;
          updateVariant();
        };
      }
    });

    updateVariant();
  }

  function updateVariant() {
    const btn = document.getElementById(`add-to-cart-btn-${sectionId}`);
    const variant = current.variants.find(v =>
      (!selected.option1 || v.option1 === selected.option1) &&
      (!selected.option2 || v.option2 === selected.option2) &&
      (!selected.option3 || v.option3 === selected.option3)
    );

    if (variant && Object.keys(selected).length === current.options.length) {
      document.getElementById(`variant-id-${sectionId}`).value = variant.id;
      document.getElementById(`modal-price-${sectionId}`).textContent = variant.priceFormatted;
      btn.disabled = !variant.available;
    } else {
      btn.disabled = true;
    }
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const variantId = document.getElementById(`variant-id-${sectionId}`).value;
    if (!variantId) return;

    const btn = document.getElementById(`add-to-cart-btn-${sectionId}`);
    btn.classList.add('loading');
    btn.disabled = true;

    try {
      await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      });

      if (shouldBundle()) await addBundle();

      const cart = await fetch('/cart.js').then(r => r.json());

      const drawer = document.querySelector('cart-drawer');
      if (drawer) {
        drawer.cart = cart;
        drawer.open();
      }

      document.dispatchEvent(new CustomEvent('cart:refresh'));

      btn.classList.remove('loading');
      btn.querySelector('span').textContent = 'Added!';

      setTimeout(() => {
        closeModal();
        btn.querySelector('span').textContent = 'Add to Cart';
        btn.disabled = false;
      }, 400);

    } catch (err) {
      console.error(err);
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  });

  function normalize(v) {
    return v?.toLowerCase().trim();
  }

  function shouldBundle() {
    if (!current.bundleCheck || !current.bundleHandle) return false;
    const req = current.bundleCheck.split(',').map(normalize);
    const sel = Object.values(selected).map(normalize);
    return req.every(v => sel.includes(v));
  }

  async function addBundle() {
    if (!cache[current.bundleHandle]) {
      const p = await fetch(`/products/${current.bundleHandle}.js`).then(r => r.json());
      cache[current.bundleHandle] = p.variants.find(v => v.available)?.id;
    }
    if (cache[current.bundleHandle]) {
      await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: cache[current.bundleHandle], quantity: 1 })
      });
    }
  }
})();
</script>


{% schema %}
{
  "name": "Product Grid",
  "tag": "section",
  "class": "section-product-grid",
  "settings": [{ "type": "text", "id": "vision_text", "label": "Vision text", "default": "Tisso vision in the wild" }],
  "blocks": [{
    "type": "product",
    "name": "Product",
    "settings": [
      { "type": "product", "id": "product", "label": "Product" },
      { "type": "header", "content": "Auto-Bundle Settings" },
      { "type": "text", "id": "bundle_variant_check", "label": "Bundle trigger variants", "info": "e.g., 'Black, Medium'", "placeholder": "Black, Medium" },
      { "type": "text", "id": "bundle_product_handle", "label": "Bundle product handle" }
    ]
  }],
  "presets": [{ "name": "Product Grid", "category": "Custom" }]
}
{% endschema %}
